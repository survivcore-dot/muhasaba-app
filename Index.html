<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Muhasaba — محاسبة روحية</title>
<link rel="manifest" href="/manifest.json" />
<meta name="theme-color" content="#0A1A2F" />
<link rel="icon" href="/assets/icons/icon-192.svg" sizes="192x192">
<style>
:root{
  --bg:#f5f6f8; --card:#fff; --muted:#6b7280; --accent:#0A1A2F; --danger:#E76F51;
  --glass: rgba(255,255,255,0.7);
}
:root[data-theme="dark"]{
  --bg:#06121a; --card:#0b1620; --muted:#9aa6b2; --accent:#9ad0d0; --glass: rgba(255,255,255,0.02);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--card-text,#0f172a);-webkit-font-smoothing:antialiased}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--card);box-shadow:0 2px 8px rgba(0,0,0,0.06);position:sticky;top:0;z-index:10}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
.title{font-size:18px;font-weight:700}
.subtitle{color:var(--muted);font-size:13px}
.container{padding:14px;max-width:980px;margin:0 auto}
.search{width:100%;padding:12px;border-radius:12px;border:1px solid #e6eef6;margin:12px 0;background:var(--glass)}
.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
.method{display:inline-block;padding:8px 10px;border-radius:10px;color:#fff;font-weight:700;margin-bottom:8px}
.GET{background:#2A9D8F}.POST{background:#264653}.PATCH{background:#F4A261}.DELETE{background:#E76F51}
.path{font-family:monospace;background:#f1f5f9;padding:6px;border-radius:8px;display:inline-block;margin-top:6px}
.meta{color:var(--muted);font-size:13px}
.offline-banner{display:none;background:#fff3cd;border:1px solid #ffeeba;padding:10px;border-radius:8px;margin-bottom:12px;color:#856404}
.offline-banner.show{display:block}
.nav{display:flex;gap:8px;align-items:center}
.icon-btn{background:transparent;border:none;padding:6px;border-radius:8px;cursor:pointer}
.pill{display:inline-block;padding:8px 12px;background:var(--card);border-radius:999px;color:var(--muted);font-weight:600}
.bottom-nav{position:fixed;left:0;right:0;bottom:12px;display:flex;gap:12px;justify-content:center;pointer-events:auto}
.nav-item{background:var(--card);padding:10px 16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);font-weight:700}
.switch{display:inline-flex;align-items:center;gap:8px}
.small{font-size:13px;color:var(--muted)}
.center{text-align:center}
.badge{background:#f1f5f9;padding:6px 8px;border-radius:8px}
.settings-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px dashed rgba(0,0,0,0.03)}
.footer{padding:18px;text-align:center;color:var(--muted)}
</style>
</head>
<body dir="rtl" data-theme="light">

<!-- Header -->
<div class="header">
  <div class="brand">
    <div class="logo">MH</div>
    <div>
      <div class="title">Muhasaba</div>
      <div class="subtitle">محاسبة روحية — مستندات API ووضع أوفلاين</div>
    </div>
  </div>
  <div class="nav">
    <button class="icon-btn" id="btn-install" title="Install app">⬇️</button>
    <button class="icon-btn" id="btn-settings" title="إعدادات">⚙️</button>
  </div>
</div>

<!-- Content -->
<div class="container">
  <div id="offlineNotice" class="offline-banner">أنت الآن أوفلاين — بعض الوظائف قد لا تكون متاحة.</div>

  <!-- views will be injected here -->
  <div id="view-root"></div>
</div>

<!-- bottom nav -->
<div class="bottom-nav" id="bottomNav" style="display:none">
  <div class="nav-item" data-href="#/">الرئيسية</div>
  <div class="nav-item" data-href="#/insights">Insights</div>
  <div class="nav-item" data-href="#/settings">Settings</div>
</div>

<script>
/* ---------- App State & Helpers ---------- */
const STORAGE = {
  THEME: 'muhasaba:theme',
  INSIGHTS: 'muhasaba:insights',
  SETTINGS: 'muhasaba:settings',
  SPEC: 'muhasaba:spec' // optional full spec
};

function $(sel,parent=document){return parent.querySelector(sel)}
function create(tag,attrs={},children=[]) {
  const e=document.createElement(tag);
  for(const k in attrs){
    if(k==='class') e.className=attrs[k];
    else if(k==='text') e.textContent=attrs[k];
    else e.setAttribute(k,attrs[k]);
  }
  (Array.isArray(children)?children:[children]).forEach(c=>{ if(!c) return; if(typeof c==='string') e.appendChild(document.createTextNode(c)); else e.appendChild(c); });
  return e;
}

/* ---------- Minimal SPEC (you can replace by full spec later) ---------- */
const DEFAULT_SPEC = {
  "openapi":"3.0.3",
  "info":{"title":"Muhasaba API","version":"1.0.0"},
  "paths":{
    "/auth/register":{"post":{"summary":"تسجيل مستخدم جديد"}},
    "/auth/login":{"post":{"summary":"تسجيل دخول"}},
    "/users/me":{"get":{"summary":"حساب المستخدم الحالية"}},
    "/hasanat":{"get":{"summary":"عرض الحسنات"},"post":{"summary":"إنشاء حسنة"}},
    "/niyyah":{"get":{"summary":"قائمة النوايا"},"post":{"summary":"إنشاء نية"}}
  }
};

function loadSpec(){
  try{
    const raw = localStorage.getItem(STORAGE.SPEC);
    return raw ? JSON.parse(raw) : DEFAULT_SPEC;
  }catch(e){ return DEFAULT_SPEC; }
}

/* ---------- Router & Views ---------- */
const root = $('#view-root');
function navTo(hash){
  location.hash = hash;
}
function renderHome(){
  document.title = "Muhasaba — الرئيسية";
  root.innerHTML = '';
  // search
  const inp = create('input',{class:'search',placeholder:'ابحث عن مسار أو كلمة...'});
  root.appendChild(inp);

  // list container
  const list = create('div',{});
  root.appendChild(list);

  // populate endpoints
  const spec = loadSpec();
  const endpoints = [];
  for(const p in spec.paths){
    for(const m in spec.paths[p]){
      const op = spec.paths[p][m];
      endpoints.push({path:p,method:m.toUpperCase(),summary: op.summary || ''});
    }
  }

  function renderList(q=''){
    list.innerHTML='';
    const f = (q||'').toLowerCase();
    const found = endpoints.filter(ep => (ep.path+' '+ep.summary).toLowerCase().includes(f));
    if(found.length===0){
      list.appendChild(create('div',{class:'card',text:'لا توجد نتائج.'}));
      return;
    }
    found.forEach(ep=>{
      const c = create('div',{class:'card'});
      c.appendChild(create('div',{class:'method '+ep.method,text:ep.method}));
      c.appendChild(create('div',{text:ep.summary}));
      c.appendChild(create('div',{class:'path',text:ep.path}));
      list.appendChild(c);
    });
  }

  inp.addEventListener('input',e=>renderList(e.target.value));
  renderList();

  // show bottom nav on home
  $('#bottomNav').style.display='flex';
}

function renderSettings(){
  document.title = "Muhasaba — الإعدادات";
  root.innerHTML='';
  $('#bottomNav').style.display='flex';

  const card = create('div',{class:'card'});
  card.appendChild(create('div',{class:'title',text:'الإعدادات'}));
  // theme toggle
  const row = create('div',{class:'settings-row'});
  row.appendChild(create('div',{text:'الوضع الداكن'}));
  const btn = create('button',{class:'pill',text:'تبديل'});
  btn.onclick = ()=>{ toggleTheme(); saveSettings(); };
  row.appendChild(btn);
  card.appendChild(row);

  // reset cache
  const row2 = create('div',{class:'settings-row'});
  row2.appendChild(create('div',{text:'مسح بيانات التطبيق (إعادة تحميل)'}));
  const cl = create('button',{class:'pill',text:'مسح'});
  cl.onclick = ()=>{ if(confirm('مسح الكاش وبيانات التطبيق؟')) { clearAppData(); location.reload(); } };
  row2.appendChild(cl);
  card.appendChild(row2);

  // upload spec (textarea)
  const row3 = create('div',{class:'settings-row'});
  const ta = create('textarea',{style:'width:100%;height:120px', placeholder:'يمكنك لصق SPEC (OpenAPI JSON) هنا لحفظها محلياً'});
  const saved = localStorage.getItem(STORAGE.SPEC) || '';
  ta.value = saved;
  const saveSpecBtn = create('button',{class:'pill',text:'حفظ SPEC'});
  saveSpecBtn.onclick = ()=>{ try{ JSON.parse(ta.value); localStorage.setItem(STORAGE.SPEC, ta.value); alert('تم حفظ SPEC محلياً'); }catch(e){ alert('الرجاء لصق JSON صالح'); } };
  row3.appendChild(ta);
  row3.appendChild(saveSpecBtn);
  card.appendChild(row3);

  root.appendChild(card);
}

function renderInsights(){
  document.title = "Muhasaba — Insights";
  root.innerHTML='';
  $('#bottomNav').style.display='flex';

  const card = create('div',{class:'card'});
  card.appendChild(create('div',{class:'title',text:'Daily Insights'}));
  const data = loadInsights();
  const list = create('div',{});
  list.appendChild(create('div',{class:'meta',text:'حسنات اليوم: '+(data.hasanat||0)}));
  list.appendChild(create('div',{class:'meta',text:'سيئات اليوم: '+(data.sayyiat||0)}));
  list.appendChild(create('div',{class:'meta',text:'نية اليوم: '+(data.niyyah||'—')}));
  list.appendChild(create('div',{class:'meta',text:'تقدم القرآن (آيات): '+(data.quran||0)}));
  card.appendChild(list);

  const row = create('div',{style:'margin-top:12px',class:'center'});
  const incHas = create('button',{class:'pill',text:'أضف حسنة'});
  incHas.onclick = ()=>{ data.hasanat=(data.hasanat||0)+1; saveInsights(data); renderInsights(); };
  const incSay = create('button',{class:'pill',style:'margin-left:8px',text:'أضف سيئة'}); incSay.onclick=()=>{ data.sayyiat=(data.sayyiat||0)+1; saveInsights(data); renderInsights(); };
  row.appendChild(incHas); row.appendChild(incSay);
  card.appendChild(row);

  root.appendChild(card);
}

/* ---------- Storage helpers ---------- */
function saveSettings(){ const s = { theme: document.documentElement.getAttribute('data-theme') || 'light' }; localStorage.setItem(STORAGE.SETTINGS, JSON.stringify(s)); }
function applySavedSettings(){ const s = JSON.parse(localStorage.getItem(STORAGE.SETTINGS) || '{}'); if(s.theme) setTheme(s.theme); }
function setTheme(mode){ document.documentElement.setAttribute('data-theme',mode); }
function toggleTheme(){ const cur = document.documentElement.getAttribute('data-theme') || 'light'; const next = cur==='light' ? 'dark' : 'light'; setTheme(next); saveSettings(); }
function clearAppData(){ localStorage.clear(); caches.keys().then(keys=>keys.forEach(k=>caches.delete(k))); alert('تم المسح'); }

/* insights storage */
function loadInsights(){ try{ return JSON.parse(localStorage.getItem(STORAGE.INSIGHTS)||'{}'); }catch(e){ return {}; } }
function saveInsights(d){ localStorage.setItem(STORAGE.INSIGHTS, JSON.stringify(d)); }

/* ---------- Router setup ---------- */
function route(){
  const hash = location.hash || '#/';
  const path = hash.replace('#','');
  if(path.startsWith('/settings')) return renderSettings();
  if(path.startsWith('/insights')) return renderInsights();
  return renderHome();
}
window.addEventListener('hashchange', route);
window.addEventListener('load', ()=>{ applySavedSettings(); route(); registerUI(); });

/* ---------- UI & install handlers ---------- */
function registerUI(){
  // bottom nav click
  document.querySelectorAll('.nav-item').forEach(it=>{
    it.onclick = ()=>navTo(it.getAttribute('data-href'));
  });

  // install flow
  const btnInstall = $('#btn-install');
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    btnInstall.style.display='inline-block';
  });
  btnInstall.onclick = async () => {
    if(deferredPrompt){
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      btnInstall.style.display='none';
    } else {
      alert('لم يظهر مربع التثبيت الآن — افتح الموقع في نافذة عادية أو نفّذ Clear & reset');
    }
  };

  // settings shortcut
  $('#btn-settings').onclick = ()=>{ navTo('#/settings'); };
}

/* ---------- Offline detection ---------- */
window.addEventListener('online', ()=>$('#offlineNotice').classList.remove('show'));
window.addEventListener('offline', ()=>$('#offlineNotice').classList.add('show'));
if(!navigator.onLine) $('#offlineNotice').classList.add('show');

/* ---------- Register service worker (will be updated by SW file) ---------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/service-worker.js').then(()=>console.log('SW registered')).catch(e=>console.warn('SW failed to register',e));
}

/* ---------- Small UX: make bottom nav visible when JS ready ---------- */
document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('bottomNav').style.display='flex'; });

</script>
</body>
</html>
