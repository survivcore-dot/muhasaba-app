<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Muhasaba — Offline API Viewer</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#213a47">

  <link rel="icon" href="./assets/icons/icon-192.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="./assets/icons/icon-512.svg">

  <style>
  /* -------- theme & base -------- */
  :root{
    --bg:#f3f6f8; --card:#ffffff; --muted:#6b7280; --accent:#1f7a6b; --accent-2:#0e84d1;
    --header:#213a47; --glass: rgba(255,255,255,0.6);
    --radius:14px; --shadow: 0 6px 20px rgba(15,23,42,0.06);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    --ease: cubic-bezier(.2,.9,.2,1);
  }
  [data-theme="dark"]{
    --bg:#071018; --card:#0c1720; --muted:#95a5b2; --accent:#1f7a6b; --accent-2:#0e84d1;
    --header:#0f2a33; --glass: rgba(255,255,255,0.03);
    color-scheme: dark;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:linear-gradient(180deg,var(--bg), #e9eef3);
    color:var(--text,#052027);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    -webkit-tap-highlight-color: transparent;
  }

  /* -------- header -------- */
  header{
    position:sticky; top:0; z-index:60;
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding:14px 16px; backdrop-filter: blur(6px);
    background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.72));
    border-bottom: 1px solid rgba(16,24,32,0.04);
  }
  [data-theme="dark"] header{ background: linear-gradient(180deg, rgba(7,10,12,0.72), rgba(7,10,12,0.56)); border-bottom:1px solid rgba(255,255,255,0.03) }
  .brand{display:flex; gap:12px; align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:var(--header);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;box-shadow:0 6px 18px rgba(33,58,71,0.12)}
  .brand h1{margin:0;font-size:18px}
  .brand .subtitle{font-size:12px;color:var(--muted);margin-top:4px}

  .controls{display:flex;gap:8px;align-items:center}
  .icon-btn{background:transparent;border:1px solid rgba(0,0,0,0.04);padding:8px;border-radius:10px;cursor:pointer;transition:all .22s var(--ease)}
  .icon-btn:active{transform:translateY(1px)}
  .icon-btn .dot{width:8px;height:8px;background:var(--accent);border-radius:999px;display:inline-block;margin-left:6px}

  /* -------- layout -------- */
  .container{max-width:980px;margin:18px auto;padding:0 14px 80px}
  .search-wrap{display:flex;gap:10px;align-items:center;margin:10px 0}
  .search{flex:1;display:block}
  .search input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(14,20,26,0.06);background:transparent;font-size:14px}
  .row{display:flex;gap:10px;align-items:center}

  /* -------- cards -------- */
  .cards{margin-top:8px;display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:820px){ .cards{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border-radius:var(--radius);padding:16px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:var(--shadow);transition:transform .22s var(--ease), box-shadow .22s var(--ease)}
  .card:hover{transform:translateY(-6px)}
  .route{flex:1}
  .route h3{margin:0;font-size:18px}
  .path{font-family:var(--mono);color:var(--muted);margin-top:8px;font-size:13px}
  .badge{display:inline-block;padding:8px 12px;border-radius:10px;color:white;font-weight:700;font-size:13px;min-width:64px;text-align:center}
  .POST{background:var(--accent)}
  .GET{background:var(--accent-2)}

  /* -------- small helpers -------- */
  footer{max-width:980px;margin:26px auto 80px;padding:0 14px;color:var(--muted);text-align:center}
  .tiny{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)}

  /* -------- toasts -------- */
  .toast-wrap{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;z-index:200;display:flex;flex-direction:column;gap:8px;align-items:center}
  .toast{background:linear-gradient(180deg,#0f1720,#0b1420);color:white;padding:10px 14px;border-radius:12px;box-shadow:0 12px 30px rgba(2,6,23,0.45);opacity:0;transform:translateY(10px) scale(.98);transition:all .26s var(--ease)}
  .toast.show{opacity:1;transform:translateY(0) scale(1)}

  /* animations */
  .fade-in{animation:fadeIn .42s both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

  /* accessibility */
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
  </style>
</head>
<body>

<header role="banner">
  <div class="brand" aria-hidden="false">
    <div class="logo" aria-hidden="true">MH</div>
    <div>
      <h1>Muhasaba</h1>
      <div class="subtitle">محاسبة روحیة — مستندات API ووضع أوفلاين</div>
    </div>
  </div>

  <div class="controls" role="toolbar" aria-label="أدوات">
    <button id="clearBtn" class="icon-btn" title="مسح الكاش">مسح الكاش</button>
    <button id="updateBtn" class="icon-btn" title="تحديث التطبيق">تحديث</button>
    <button id="themeBtn" class="icon-btn" title="تبديل الوضع">وضع</button>
  </div>
</header>

<main class="container" role="main">
  <div class="search-wrap">
    <div class="search">
      <input id="q" placeholder="ابحث عن مسار أو كلمة..." aria-label="بحث" />
    </div>
    <div class="row">
      <button id="installBtn" class="icon-btn" title="تثبيت التطبيق">تثبيت</button>
    </div>
  </div>

  <section id="routes" class="cards" aria-live="polite">
    <!-- بطاقات العرض تبدأ هنا - تبقى ديناميكية لاحقاً -->
    <article class="card fade-in" data-method="post">
      <div class="route">
        <h3>Register a new user</h3>
        <div class="path">/auth/register</div>
      </div>
      <div><span class="badge POST" aria-hidden="true">POST</span></div>
    </article>

    <article class="card fade-in" data-method="post">
      <div class="route">
        <h3>Login</h3>
        <div class="path">/auth/login</div>
      </div>
      <div><span class="badge POST" aria-hidden="true">POST</span></div>
    </article>

    <article class="card fade-in" data-method="post">
      <div class="route">
        <h3>Create device anonymous account</h3>
        <div class="path">/auth/device-anon</div>
      </div>
      <div><span class="badge POST" aria-hidden="true">POST</span></div>
    </article>

    <article class="card fade-in" data-method="get">
      <div class="route">
        <h3>Get current user profile</h3>
        <div class="path">/users/me</div>
      </div>
      <div><span class="badge GET" aria-hidden="true">GET</span></div>
    </article>
  </section>

</main>

<footer>
  <div class="tiny muted">Muhasaba PWA © <span id="yr"></span> — يعمل أوفلاين</div>
</footer>

<!-- Toasts container -->
<div class="toast-wrap" id="toasts" aria-live="assertive" aria-atomic="true"></div>

<script>
/* -------- small helpers -------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* footer year */
document.getElementById('yr').innerText = new Date().getFullYear();

/* theme toggle */
const themeBtn = $('#themeBtn');
const savedTheme = localStorage.getItem('muh_theme');
if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
themeBtn.addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme');
  const next = cur === 'dark' ? '' : 'dark';
  if(next) document.documentElement.setAttribute('data-theme', next); else document.documentElement.removeAttribute('data-theme');
  localStorage.setItem('muh_theme', next);
  showToast(next ? 'الوضع الليلي مفعل' : 'الوضع النهاري مفعل');
});

/* toast util */
function showToast(text, ms=2200){
  const wrap = $('#toasts');
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerText = text;
  wrap.appendChild(t);
  requestAnimationFrame(()=> t.classList.add('show'));
  setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> t.remove(),260); }, ms);
}

/* search */
$('#q').addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  $$('.card').forEach(card=>{
    const match = card.innerText.toLowerCase().includes(q);
    card.style.display = match ? 'flex' : 'none';
  });
});

/* Install prompt (deferred prompt) */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $('#installBtn').style.display = 'inline-block';
});
$('#installBtn').addEventListener('click', async () => {
  if(deferredPrompt){
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    showToast(choice.outcome === 'accepted' ? 'تم تثبيت التطبيق' : 'تم إلغاء التثبيت');
    deferredPrompt = null;
  } else {
    showToast('خيار التثبيت غير متاح حالياً');
  }
});

/* Register SW (relative) */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./service-worker.js').then(reg => {
    console.log('SW registered', reg);
    // handle waiting SW -> show toast
    if(reg.waiting) showToast('نسخة جديدة جاهزة. اضغط تحديث.');
    reg.addEventListener('updatefound', () => {
      const nw = reg.installing;
      nw.addEventListener('statechange', () => {
        if(nw.state === 'installed') showToast('تحديث جاهز. اضغط تحديث.');
      });
    });
  }).catch(e => console.warn('SW register failed', e));
}

/* Update button: ask SW to skipWaiting */
$('#updateBtn').addEventListener('click', async () => {
  const reg = await navigator.serviceWorker.getRegistration();
  if(reg && reg.waiting){
    reg.waiting.postMessage({type:'SKIP_WAITING'});
    navigator.serviceWorker.addEventListener('controllerchange', ()=> location.reload());
    showToast('تطبيق جديد سيتم تفعيله الآن...');
  } else {
    showToast('لايوجد تحديث جاهز - جاري إعادة التحميل');
    location.reload();
  }
});

/* Clear cache button (programmatic clear) */
$('#clearBtn').addEventListener('click', async () => {
  try{
    const ks = await caches.keys();
    await Promise.all(ks.map(k => caches.delete(k)));
    const regs = await navigator.serviceWorker.getRegistrations();
    await Promise.all(regs.map(r => r.unregister()));
    showToast('تم مسح الكاش وإلغاء تسجيل Service Worker');
    setTimeout(()=> location.reload(true), 600);
  }catch(e){
    console.error(e);
    showToast('خطأ أثناء مسح الكاش');
  }
});

/* keyboard shortcuts for accessibility: "/" to focus search */
window.addEventListener('keydown', (e) => {
  if(e.key === '/') { e.preventDefault(); $('#q').focus(); }
});

/* small visual feedback on cards click */
$$('.card').forEach(c => c.addEventListener('click', () => {
  c.animate([{transform:'scale(1)'},{transform:'scale(.995)'}],{duration:150,fill:'both'});
  showToast('تم اختيار: ' + (c.querySelector('h3')?.innerText || 'مسار'));
}));

/* ensure to hide install button if unsupported */
if(!window.beforeinstallprompt && !navigator.standalone) $('#installBtn').style.display = 'none';

/* --- progressive enhancement: load dynamic list if JSON exists --- */
async function loadRoutesFromJSON(){
  try{
    const r = await fetch('./routes.json', {cache:'no-store'});
    if(!r.ok) return;
    const arr = await r.json();
    const container = $('#routes');
    container.innerHTML = ''; // clear current
    arr.forEach(item => {
      const card = document.createElement('article');
      card.className='card fade-in';
      card.dataset.method = (item.method||'get').toLowerCase();
      card.innerHTML = `
        <div class="route"><h3>${item.title}</h3><div class="path">${item.path}</div></div>
        <div><span class="badge ${item.method?.toUpperCase() === 'POST' ? 'POST' : 'GET'}">${(item.method||'GET').toUpperCase()}</span></div>
      `;
      container.appendChild(card);
    });
  }catch(e){ /* silent */ }
}
loadRoutesFromJSON();

</script>

</body>
  </html>
